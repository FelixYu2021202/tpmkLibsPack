// ==UserScript==
// @name         Hfoj Better
// @namespace    http://hfoj.net/
// @version      1.1.0
// @description  Add functions to hfoj
// @author       cosf
// @match        http://*.hfoj.net/*
// @icon         http://hfoj.net/favicon.ico
//
// @require      https://code.jquery.com/jquery-3.7.1.min.js
// ==/UserScript==
!function(){"use strict";"undefined"==typeof $&&($=require("jquery"));const e=location.pathname,t=e.match(/\/d\/(\w+)/)?.[1],s=t?e.replace(/\/d\/(\w+)/,""):e,i=(function(e){let t={};e.substring(1).split("&").forEach((e=>{let s=e.split("=");t[s[0]]=s[1]}))}(location.search),["SGFwcHlib2IgU2F5cyBZb3hp","SGFwcHlib2Igc2F5cyAiQ3VhenlveGkgeW94aSEi","RG9uJ3QgYmUgZGVjYWRlbnQhIQ==","JUU3JThFJUE5TyVFNyU4RSVBOSVFNyU5QSU4NA==","JUU2JThCJTlDJUU4JUIwJUEyJUU2JTlDJTg4JUU0JUJBJUFF","JUU2JUIwJUE3JUU0JUJDJTlBJUU3JTg3JTgzJUVGJUJDJThDJUU2JUIwJUE3JUU2JTk3JUJBJUU3JTg3JTgz"]),o=["其他 (0)","入门 (1)","普及- (2)","普及/提高- (3)","普及+/提高 (4)","提高+/省选- (5)","省选/NOI- (6)","NOI/NOI+/CTSC (7)","(8)","(9)","(10)"];localStorage.getItem("selectedDifficulties")||localStorage.setItem("selectedDifficulties","[1,1,1,1,1,1,1,1]");const c=JSON.parse(localStorage.getItem("selectedDifficulties")),n=["unselected","selected"],a={home:/^\/$/,homeIn:/^\/home/,problems:/^\/p(\/?)$/,homework:/^\/homework(\/?)$/,homeworkIn:/^\/homework/,discuss:/^\/discuss(\/?)$/,discussIn:/^\/discuss/,record:/^\/record(\/?)$/,recordIn:/^\/record/,ranking:/^\/ranking(\/?)$/,userIn:/^\/user/,blogIn:/^\/blog/};function d(e,t){let s=!0;return t.forEach((t=>s&&=e.match(a[t]))),s}if($("<style>.section{border-radius:10px}.exrand-block{width:20px;height:20px;margin:10px;border:1px solid black;display:block;text-align:center;line-height:20px}.exrand-selector{display:flex}.exrand-submit{margin-top:10px}.exrand-text{margin-top:10px;margin-bottom:10px;line-height:20px}*[unselected]{background-color:var(--exrand-unselected)}*[selected]{background-color:var(--exrand-selected)}*{--exrand-selected:#3c;--exrand-unselected:#ff;--exrand-background:#ee}</style>").appendTo($(document.body)),d(s,["home"])&&($('.section.side:contains("推荐")').remove(),$('.section.side:contains("一言")').remove()),d(s,["problems"])&&$('.section.side:contains("进入编辑模式")').remove(),d(s,["discuss"])&&$('.section.side:contains("讨论节点")').remove(),d(s,["home"])){$(`<div class="section side visible" style="border-radius:10px"><div class="section__header"><h1 class="section__title">一言</h1><p>${decodeURIComponent(atob(i[Math.floor(Math.random()*i.length)]))}</p></div></div>`).prependTo($(".large-3, .medium-3")[0])}if(function(e,t){let s=!1;return t.forEach((t=>s||=e.match(a[t]))),!s}(s,["homeworkIn","discussIn","recordIn","ranking","userIn","homeIn","blogIn"])){let s=$('<div class="section side visible" style="border-radius:10px"><div class="section__header"><h1 class="section__title">随机 ex</h1></div></div>'),i=$('<div class="section__body"></div>').appendTo(s);if(e.match(/\/p\/\w+/)){let e=$("*:contains(难度).problem__tag-item");e.text(e.text().replace(/\d+/,(e=>o[e])))}let a=$('<div class="exrand-select"><div class="expanded button">选择难度</div></div>');class d{constructor(e,t){this.jqe=$(`<div exrand-difficulty-${e} class="exrand-selector"><span class="exrand-text">${o[e]}</span></div>`).appendTo(t),this.box=$(`<span class="exrand-block" ${n[c[e]]}></span>`).prependTo(this.jqe),this.jqe.on("click",(()=>{this.box.removeAttr(n[c[e]]),c[e]=1-c[e],localStorage.setItem("selectedDifficulties",JSON.stringify(c)),this.box.attr(n[c[e]],"")}))}}for(let e=0;e<8;e++)new d(e,a);a=a.appendTo(i);let l=!1;a.on("click",(()=>{l?a.find(".exrand-selector").hide():a.find(".exrand-selector").show(),l=!l})),a.find(".exrand-selector").hide(),$('<div><p class="expanded button exrand-submit">随机</p></div>').appendTo(i).on("click",(()=>{let e="";c.forEach(((t,s)=>{t&&(e+=","+s)})),e=e.substring(1),t?$.ajax({method:"GET",url:`/d/${t}/p?q=difficulty:${e}`,headers:{accept:"application/json"},success(s){let i=s.pcount,o=Math.ceil(Math.random()*i),c=Math.ceil(o/100),n=(o-1)%100+1;$.get(`/d/${t}/p?q=difficulty:${e}&page=${c}`,(e=>{let t=$(e).find(".col--pid")[n].innerText;location=`/p/${t}`}))}}):$.ajax({method:"GET",url:`/p?q=difficulty:${e}`,headers:{accept:"application/json"},success(t){let s=t.pcount,i=Math.ceil(Math.random()*s),o=Math.ceil(i/100),c=(i-1)%100;$.ajax({method:"GET",url:`/p?q=difficulty:${e}&page=${o}`,headers:{accept:"application/json"},success(e){console.log(e);let t=e.pdocs[c].docId;location=`/p/${t}`}})}})})),s=s.prependTo($(".large-3, .medium-3")[0])}}();