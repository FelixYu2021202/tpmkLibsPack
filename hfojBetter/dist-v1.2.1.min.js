// ==UserScript==
// @name         Hfoj Better
// @namespace    http://hfoj.net/
// @version      1.2.1
// @description  Add functions to hfoj
// @author       cosf
// @match        http://*.hfoj.net/*
// @icon         http://hfoj.net/favicon.ico
// ==/UserScript==

// JQuery-v3.7.1 already satisfied by hfoj.

!function(){"use strict";"undefined"==typeof $&&($=require("jquery"));const e=location.pathname,n=e.match(/\/d\/(\w+)/)?.[1],t=n?e.replace(/\/d\/(\w+)/,""):e;!function(e){let n={};e.substring(1).split("&").forEach((e=>{let t=e.split("=");n[t[0]]=t[1]}))}(location.search);function o(){return n?`/d/${n}`:""}const i=["SGFwcHlib2IgU2F5cyBZb3hp","SGFwcHlib2Igc2F5cyAiQ3VhenlveGkgeW94aSEi","RG9uJ3QgYmUgZGVjYWRlbnQhIQ==","JUU3JThFJUE5TyVFNyU4RSVBOSVFNyU5QSU4NA==","JUU2JThCJTlDJUU4JUIwJUEyJUU2JTlDJTg4JUU0JUJBJUFF","JUU2JUIwJUE3JUU0JUJDJTlBJUU3JTg3JTgzJUVGJUJDJThDJUU2JUIwJUE3JUU2JTk3JUJBJUU3JTg3JTgz"],c=["其他 (0)","入门 (1)","普及- (2)","普及/提高- (3)","普及+/提高 (4)","提高+/省选- (5)","省选/NOI- (6)","NOI/NOI+/CTSC (7)","(8)","(9)","(10)"];localStorage.getItem("selectedDifficulties")||localStorage.setItem("selectedDifficulties","[1,1,1,1,1,1,1,1]");const a=JSON.parse(localStorage.getItem("selectedDifficulties")),s=["unselected","selected"],r={home:/^\/$/,homeIn:/^\/home/,problems:/^\/p(\/?)$/,problem:/^\/p\/\w+(\/?)$/,pid:/([^\/]+)(\/?)$/,homework:/^\/homework(\/?)$/,homeworkIn:/^\/homework/,discuss:/^\/discuss(\/?)$/,discussIn:/^\/discuss/,record:/^\/record(\/?)$/,recordIn:/^\/record/,ranking:/^\/ranking(\/?)$/,userIn:/^\/user/,blogIn:/^\/blog/};function d(e,n){let t=!0;return n.forEach((n=>t&&=e.match(r[n]))),t}const l={luogu:"luogu.cxx/14/gcco2",[null]:"cc.cc17o2",[void 0]:"cc.cc17o2",python:"py.py3",ybtqm:"cc.cc17o2",ybttg:"cc.cc17o2",jjzn:"cc.cc17o2",codeforces:"yoxi"},p={luogu:"NOI 标准语言 C++14 (O2)",[null]:"C++17 (O2)",[void 0]:"C++17 (O2)",python:"Python 3",ybtqm:"C++17 (O2)",ybttg:"C++17 (O2)",jjzn:"C++17 (O2)",codeforces:"**无法提交**"};if($("<style>.section {border-radius: 10px;}.exrand-block {width: 20px;height: 20px;margin: 10px;border: 1px solid black;display: block;text-align: center;line-height: 20px;}.exrand-select {/* border: 1px solid black; */}.exrand-selector {display: flex;}.exrand-submit {margin-top: 10px;}.exrand-text {margin-top: 10px;margin-bottom: 10px;line-height: 20px;}*[unselected] {background-color: var(--exrand-unselected);}*[selected] {background-color: var(--exrand-selected);}* {--exrand-selected: rgb(60 65 80);--exrand-unselected: rgb(255 255 255);--exrand-background: rgb(238 238 238);}</style>").appendTo($(document.body)),d(t,["home"])&&($('.section.side:contains("推荐")').remove(),$('.section.side:contains("一言")').remove()),d(t,["problems"])&&$('.section.side:contains("进入编辑模式")').remove(),d(t,["discuss"])&&$('.section.side:contains("讨论节点")').remove(),d(t,["home"])){$(`<div class="section side visible" style="border-radius: 10px;"><div class="section__header"><h1 class="section__title">一言</h1><p>${decodeURIComponent(atob(i[Math.floor(Math.random()*i.length)]))}</p></div></div>`).prependTo($(".large-3, .medium-3")[0])}if(function(e,n){let t=!1;return n.forEach((n=>t||=e.match(r[n]))),!t}(t,["homeworkIn","discussIn","recordIn","ranking","userIn","homeIn","blogIn"])){let n=$('<div class="section side visible" style="border-radius: 10px;"><div class="section__header"><h1 class="section__title">随机 ex</h1></div></div>'),t=$('<div class="section__body"></div>').appendTo(n);if(e.match(/\/p\/\w+/)){let e=$("*:contains(难度).problem__tag-item");e.text(e.text().replace(/\d+/,(e=>c[e])))}let i=$('<div class="exrand-select"><div class="expanded button">选择难度</div></div>');class r{constructor(e,n){this.jqe=$(`<div exrand-difficulty-${e} class="exrand-selector"><span class="exrand-text">${c[e]}</span></div>`).appendTo(n),this.box=$(`<span class="exrand-block" ${s[a[e]]}></span>`).prependTo(this.jqe),this.jqe.on("click",(()=>{this.box.removeAttr(s[a[e]]),a[e]=1-a[e],localStorage.setItem("selectedDifficulties",JSON.stringify(a)),this.box.attr(s[a[e]],"")}))}}for(let e=0;e<8;e++)new r(e,i);i=i.appendTo(t);let d=!1;i.on("click",(()=>{d?i.find(".exrand-selector").hide():i.find(".exrand-selector").show(),d=!d})),i.find(".exrand-selector").hide(),$('<div><p class="expanded button exrand-submit">随机</p></div>').appendTo(t).on("click",(()=>{let e="";a.forEach(((n,t)=>{n&&(e+=","+t)})),e=e.substring(1),$.ajax({method:"GET",url:`${o()}/p?q=difficulty:${e}`,headers:{accept:"application/json"},success(n){let t=n.pcount,i=Math.ceil(Math.random()*t),c=Math.ceil(i/100),a=(i-1)%100;$.ajax({method:"GET",url:`${o()}/p?q=difficulty:${e}&page=${c}`,headers:{accept:"application/json"},success(e){console.log(e);let n=e.pdocs[a].docId;location=`${o}/p/${n}`}})}})})),n=n.prependTo($(".large-3, .medium-3")[0])}if(d(t,["problem"])){let e=t.match(r.pid)[1],i=$('<input type="submit" class="rounded primary button" value="递交"></input>');i.on("click",(()=>{let t=$("textarea").val();fetch(`${o()}/p/${e}/submit`,{headers:{accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7","accept-language":"zh-CN,zh;q=0.9,en;q=0.8","cache-control":"max-age=0","content-type":"multipart/form-data; boundary=----WebKitFormBoundaryHappybobSaysYoxi","upgrade-insecure-requests":"1"},referrer:`${o()}/p/${e}/submit`,referrerPolicy:"strict-origin-when-cross-origin",body:`------WebKitFormBoundaryHappybobSaysYoxi\r\nContent-Disposition: form-data; name="lang"\r\n\r\n${l[n]}\r\n------WebKitFormBoundaryHappybobSaysYoxi\r\nContent-Disposition: form-data; name="code"\r\n\r\n${t}\r\n------WebKitFormBoundaryHappybobSaysYoxi\r\nContent-Disposition: form-data; name="file"; filename=""\r\nContent-Type: application/octet-stream\r\n\r\n\r\n------WebKitFormBoundaryHappybobSaysYoxi--\r\n`,method:"POST",mode:"cors",credentials:"include"}).then((e=>{location=e.url}))}));let c=$(`<div class="section__body"><label>代码语言：${p[n]}</label><div class="medium-12"><textarea class="textbox monospace" spellcheck="false"></textarea></div></div>`).append(i),a=$('<div class="section visible"><div class="section__header">提交代码</div></div>').append(c);$(".medium-9.columns").append(a)}}();