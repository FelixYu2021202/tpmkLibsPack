// ==UserScript==
// @name         Hfoj Better
// @namespace    http://hfoj.net/
// @version      1.6.0
// @description  Add functions to hfoj
// @author       cosf
// @match        http://*.hfoj.net/*
// @grant        GM_xmlhttpRequest
// @icon         http://hfoj.net/favicon.ico
// ==/UserScript==

!function(){"use strict";"undefined"==typeof $&&($=require("jquery"));const e=location.pathname,n=e.match(/\/d\/(\w+)/)?.[1],t=n?e.replace(/\/d\/(\w+)/,""):e,s=function(e){let n={};return e.substring(1).split("&").forEach((e=>{let t=e.split("=");n[t[0]]=t[1]})),n}(location.search);!function(e){let n={};e.split("; ").forEach((e=>{let t=e.split("=");n[t[0]]=t[1]}))}(document.cookie);function i(e){return s[e]?`${e}=${s[e]}`:""}const o=$("a.nav__item").last()[0].href.match(/\d+$/)[0];function c(){return n?`/d/${n}`:""}const a=["SGFwcHlib2IgU2F5cyBZb3hp","SGFwcHlib2Igc2F5cyAiQ3VhenlveGkgeW94aSEi","RG9uJ3QgYmUgZGVjYWRlbnQhIQ==","JUU3JThFJUE5TyVFNyU4RSVBOSVFNyU5QSU4NA==","JUU2JThCJTlDJUU4JUIwJUEyJUU2JTlDJTg4JUU0JUJBJUFF","JUU2JUIwJUE3JUU0JUJDJTlBJUU3JTg3JTgzJUVGJUJDJThDJUU2JUIwJUE3JUU2JTk3JUJBJUU3JTg3JTgz","JUU2JTlDJTg4JUU0JUJBJUFFJUU1JUE1JUJEJUU5JTk3JUFBJUVGJUJDJThDJUU2JThCJTlDJUU4JUIwJUEyJUU2JTlDJTg4JUU0JUJBJUFF","JUU4JThCJUE1JUU4JUEyJUFCJUU1JThGJTkxJUU3JThFJUIwJUU4JUJGJTlEJUU4JUE3JTg0JUVGJUJDJThDJUU1JUIwJTg2JUU4JUEyJUFCJTIwQ0NGJTIwJUU3JUE2JTgxJUU4JUI1JTlCJUU0JUI4JTg5JUU1JUI5JUI0JUUzJTgwJTgy","WW91J3JlJTIwd3JvbmcuJTIwSGVyZSUyMGlzJTIwd2h5Lg==","SGFwcHklMjBCb2IlMjBoZWxwcyUyMHlvdSUyMHRvJTIwZmVlbCUyMGxpa2UlMjBhJTIwcGVyc29uJTJDJTIwbm90JTIwYSUyMHBhdGllbnQu"],r=["其他 (0)","入门 (1)","普及- (2)","普及/提高- (3)","普及+/提高 (4)","提高+/省选- (5)","省选/NOI- (6)","NOI/NOI+/CTSC (7)","(8)","(9)","(10)"];localStorage.getItem("selectedDifficulties")||localStorage.setItem("selectedDifficulties","[1,1,1,1,1,1,1,1]");const d=JSON.parse(localStorage.getItem("selectedDifficulties")),l=["unselected","selected"],p={0:"Fetched",1:"Accepted",2:"Wrong Answer",7:"Compile Error",8:"System Error",20:"Running",22:"Compiling"},u={0:"#f3a83f",1:"#61c25a",2:"#fb6666",7:"#fb6666",8:"#fb6666",20:"#f3a83f",22:"#f3a83f"},h={0:"#f3a83f",1:"#25ad40",2:"#fb5555",7:"#fb5555",8:"#fb5555",20:"#f3a83f",22:"#f3a83f"},m={0:"#fff8bf",1:"#90ffa0",2:"#ffbbbb",7:"#ffbbbb",8:"#ffbbbb",20:"#fff8bf",22:"#fff8bf"},b={home:/^\/$/,homeIn:/^\/home/,problems:/^\/p(\/?)$/,problem:/^\/p\/\w+(\/?)$/,pid:/([^\/]+)(\/?)$/,homework:/^\/homework(\/?)$/,homeworkIn:/^\/homework/,discuss:/^\/discuss(\/?)$/,discussIn:/^\/discuss/,record:/^\/record(\/?)$/,recordIn:/^\/record/,ranking:/^\/ranking(\/?)$/,userIn:/^\/user/,blogIn:/^\/blog/};function J(e,n){let t=!1;return n.forEach((n=>t||=e.match(b[n]))),t}const g=["luogu","system","python","ybtqm","ybttg","jjzn","codeforces"],f={luogu:"luogu.cxx/14/gcco2",[null]:"cc.cc17o2",[void 0]:"cc.cc17o2",system:"cc.cc17o2",python:"py.py3",ybtqm:"cc.cc17o2",ybttg:"cc.cc17o2",jjzn:"cc.cc17o2",codeforces:"codeforces.54"},U={luogu:"NOI 标准语言 C++14 (O2)",[null]:"C++17 (O2)",[void 0]:"C++17 (O2)",system:"C++17 (O2)",python:"Python 3",ybtqm:"C++17 (O2)",ybttg:"C++17 (O2)",jjzn:"C++17 (O2)",codeforces:"GNU G++17 7.3.0"};if($("<style>\n.section {\nborder-radius: 10px;\n}\n\n.exrand-block {\nwidth: 20px;\nheight: 20px;\nmargin: 10px;\nborder: 1px solid black;\ndisplay: block;\ntext-align: center;\nline-height: 20px;\n}\n\n.exrand-select {\n/* border: 1px solid black; */\n}\n\n.exrand-selector {\ndisplay: flex;\n}\n\n.exrand-submit {\nmargin-top: 10px;\n}\n\n.exrand-text {\nmargin-top: 10px;\nmargin-bottom: 10px;\nline-height: 20px;\n}\n\n.jmp-right {\nmargin-right: 10px !important;\n}\n\n.smc-sbm {\ndisplay: flex;\nflex-direction: row;\nheight: 40.15px;\n}\n\n.smc-sbmi {\nheight: 40.15px;\nline-height: 40.15px;\n}\n\n.smc-sbms {\npadding-left: 10px;\n}\n\n*[unselected] {\nbackground-color: var(--exrand-unselected);\n}\n\n*[selected] {\nbackground-color: var(--exrand-selected);\n}\n\n* {\n--exrand-selected: rgb(20 255 20);\n--exrand-unselected: rgb(128 128 128);\n--exrand-background: rgb(238 238 238);\n}\n</style>").appendTo($(document.body)),J(t,["home"])&&($('.section.side:contains("推荐")').remove(),$('.section.side:contains("一言")').remove()),J(t,["problems"])&&$('.section.side:contains("进入编辑模式")').remove(),J(t,["discuss"])&&$('.section.side:contains("讨论节点")').remove(),$(".error__container").length>0){let x=$("h1").first();x.text("错误！3秒后返回上一页");let y=setTimeout((()=>{history.go(-1)}),3e3);x.on("dblclick",(()=>{x.text("错误！"),clearTimeout(y)}))}else{if(J(t,["home"])){$(`<div class="section side visible" style="border-radius: 10px;">\n<div class="section__header">\n<h1 class="section__title">\n一言\n</h1>\n</div>\n<div class="section__body">\n<p>\n${decodeURIComponent(atob(a[Math.floor(Math.random()*a.length)]))}\n</p>\n</div>\n</div>`).prependTo($(".large-3, .medium-3").first())}{let v=$('<div class="section side visible" type="border-radius: 10px;">\n<div class="section__header">\n<h1 class="section__title">\n跳转\n</h1>\n</div>\n</div>'),T=$('<div class="section__body"></div>');g.forEach((e=>{let n=$(`<div class="button jmp-right">${e}</div>`);n.on("click",(()=>{J(t,["home","homeIn","problems","homework","discuss","record","ranking","userIn","blogIn"])?location=`/d/${e}${t}`:location=`/d/${e}/`})),n.appendTo(T)})),v.append(T).appendTo($(".large-3, .medium-3").first())}if(J(t,["home","problems","problem"])){let _=$('<div class="section side visible" style="border-radius: 10px;">\n<div class="section__header">\n<h1 class="section__title">\n随机 ex\n</h1>\n</div>\n</div>'),I=$('<div class="section__body">\n</div>').appendTo(_);if(e.match(/\/p\/\w+/)){let S=$("*:contains(难度).problem__tag-item");S.text(S.text().replace(/\d+/,(e=>r[e])))}let w=$('<div class="exrand-select">\n<div class="expanded button">\n选择难度\n</div>\n</div>');class k{constructor(e,n){this.jqe=$(`<div exrand-difficulty-${e} class="exrand-selector">\n<span class="exrand-text">${r[e]}</span>\n</div>`).appendTo(n),this.box=$(`<span class="exrand-block" ${l[d[e]]}></span>`).prependTo(this.jqe),this.jqe.on("click",(()=>{this.box.removeAttr(l[d[e]]),d[e]=1-d[e],localStorage.setItem("selectedDifficulties",JSON.stringify(d)),this.box.attr(l[d[e]],"")}))}}for(let E=0;E<8;E++)new k(E,w);w=w.appendTo(I);let j=!1;w.children().first().on("click",(()=>{j?w.find(".exrand-selector").hide():w.find(".exrand-selector").show(),j=!j})),w.find(".exrand-selector").hide(),$('<div>\n<p class="expanded button exrand-submit">\n随机\n</p>\n</div>').appendTo(I).on("click",(()=>{let e="";d.forEach(((n,t)=>{n&&(e+=","+t)})),e=e.substring(1),$.ajax({method:"GET",url:`${c()}/p?q=difficulty:${e}`,headers:{accept:"application/json"},success(n){let t=n.pcount,s=Math.ceil(Math.random()*t),i=Math.ceil(s/100),o=(s-1)%100;$.ajax({method:"GET",url:`${c()}/p?q=difficulty:${e}&page=${i}`,headers:{accept:"application/json"},success(e){console.log(e);let n=e.pdocs[o].docId;location=`${c()}/p/${n}`}})}})})),_=_.prependTo($(".large-3, .medium-3").first())}if(J(t,["problem"])){let C=t.match(b.pid)[1],F=$('<div class="section__body"></div>');class G{constructor(e,n){this.subid=e,console.log(this.subid),this.jqe=$(`<a class="smc-sbm" href="${c()}/record/${this.subid}" target="_blank"></a>`)[n](F),this.update()}update(){let e=this;$.ajax({url:`${c()}/record/${e.subid}?${i("tid")}`,method:"GET",headers:{accept:"application/json"},success(n){let t=n.rdoc;console.log(t.status),(t.status>8||0==t.status)&&setTimeout(e.update.bind(e),500),t.judgeAt||(t.judgeAt="Judging"),e.jqe.html(`<span style="border-left: .1875rem solid ${u[t.status]}; color: ${h[t.status]}" class="smc-sbmi smc-sbms">\n${t.score} ${p[t.status]}\n</span>\n<span style="margin-left: auto">\n${t.judgeAt}\n</span>\n`),t.progress||(t.progress=0),e.jqe.css(`background", "rgb(0, 0) linear-gradient(to right, ${m[t.status]} ${t.progress}%, rgba(0, 0, 0, 0) ${t.progress}%) repeat scroll 0% 0% / auto border-box border-box`)}})}}function q(){$.ajax({url:`${c()}/record?uidOrName=${o}&pid=${C}&${i("tid")}`,method:"GET",headers:{accept:"application/json"},success(e){e.rdocs.forEach((e=>{new G(e._id,"appendTo")}))}})}function D(e){let n=e.url.match(b.pid)[0];new G(n,"prependTo")}q();let O=$('<input type="submit" class="rounded primary button" value="递交"></input>');O.on("click",(()=>{let e=$("textarea").val();fetch(`${c()}/p/${C}/submit?${i("tid")}`,{headers:{accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7","accept-language":"zh-CN,zh;q=0.9,en;q=0.8","cache-control":"max-age=0","content-type":"multipart/form-data; boundary=----WebKitFormBoundaryHappybobSaysYoxi","upgrade-insecure-requests":"1"},referrer:`${c()}/p/${C}/submit`,referrerPolicy:"strict-origin-when-cross-origin",body:`------WebKitFormBoundaryHappybobSaysYoxi\r\nContent-Disposition: form-data; name="lang"\r\n\r\n${f[n]}\r\n------WebKitFormBoundaryHappybobSaysYoxi\r\nContent-Disposition: form-data; name="code"\r\n\r\n${e}\r\n------WebKitFormBoundaryHappybobSaysYoxi\r\nContent-Disposition: form-data; name="file"; filename=""\r\nContent-Type: application/octet-stream\r\n\r\n\r\n------WebKitFormBoundaryHappybobSaysYoxi--\r\n`,method:"POST",mode:"cors",credentials:"include"}).then(D)}));let B=$(`<div class="section__body">\n<label>\n代码语言：${U[n]}\n</label>\n<div class="medium-12">\n<textarea class="textbox monospace" spellcheck="false"></textarea>\n</div>\n</div>`).append(O),M=$('<div class="section visible">\n<div class="section__header">\n提交代码\n</div>\n</div>').append(B),N=$('<div class="section visible">\n<div class="section__header">\n提交记录\n</div>\n</div>').append(F);$(".medium-9.columns").append(M,N)}if($(".section").each((function(){if(2!=$(this).children().length)return;let e=$(this).children(".section__body");if(1!=e.length)return;let n=$(this).children(".section__header");if(1!=n.length)return;let t=$('<div class="button">隐藏</div>').appendTo(n);t.on("click",(()=>{"隐藏"==t.text()?(e.hide(),t.text("显示")):(e.show(),t.text("隐藏"))}))})),J(t,["problem"])){let H=t.match(b.pid)[1],V=$('<div class="section side visible" style="border-radius: 10px;">\n<div class="section__header">\n<h1 class="section__title">\n传送至 cph\n</h1>\n</div>\n</div>'),W=$('<div class="expanded button">传送</div>');W.on("click",(()=>{let e=[],n=1;for(;1==$(`code.language-input${n}`).length;)e.push({input:$(`code.language-input${n}`).text(),output:$(`code.language-output${n}`).text()}),n++;GM_xmlhttpRequest({url:"http://localhost:27121/",method:"POST",data:JSON.stringify({batch:{id:"hfoj-better",size:1},name:H,url:location.toString(),interactive:"false",memoryLimit:524288,timeLimit:5e3,tests:e,input:{type:"stdin"},output:{type:"stdout"},testType:"single"}),onload(e){502==e.status&&alert("未启动 cph")},onerror(){alert("传送失败")}})})),V.append($('<div class="section__body"></div>').append(W)).prependTo($(".large-3, .medium-3").first())}}}();